"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getPropertiesAtLocation = void 0;
const language_core_1 = require("@vue/language-core");
const utils_1 = require("../utils");
function getPropertiesAtLocation(fileName, position, isTsPlugin = true) {
    const match = (0, utils_1.getProject)(fileName);
    if (!match) {
        return;
    }
    const { info, files, ts } = match;
    const languageService = info.languageService;
    // mapping
    const file = files.get(fileName);
    if (file?.generated) {
        const virtualScript = file.generated.languagePlugin.typescript?.getScript(file.generated.code);
        if (!virtualScript) {
            return;
        }
        let mapped = false;
        for (const [_1, [_2, map]] of files.getMaps(virtualScript.code)) {
            for (const [position2, mapping] of map.getGeneratedOffsets(position)) {
                if ((0, language_core_1.isCompletionEnabled)(mapping.data)) {
                    position = position2;
                    mapped = true;
                    break;
                }
            }
            if (mapped) {
                break;
            }
        }
        if (!mapped) {
            return;
        }
        if (isTsPlugin) {
            position += file.snapshot.getLength();
        }
    }
    const program = languageService.getCurrentProgram();
    if (!program) {
        return;
    }
    const sourceFile = program.getSourceFile(fileName);
    if (!sourceFile) {
        return;
    }
    const node = findPositionIdentifier(sourceFile, sourceFile, position);
    if (!node) {
        return;
    }
    const checker = program.getTypeChecker();
    const type = checker.getTypeAtLocation(node);
    const props = type.getProperties();
    return props.map(prop => prop.name);
    function findPositionIdentifier(sourceFile, node, offset) {
        let result;
        node.forEachChild(child => {
            if (!result) {
                if (child.end === offset && ts.isIdentifier(child)) {
                    result = child;
                }
                else if (child.end >= offset && child.getStart(sourceFile) < offset) {
                    result = findPositionIdentifier(sourceFile, child, offset);
                }
            }
        });
        return result;
    }
}
exports.getPropertiesAtLocation = getPropertiesAtLocation;
//# sourceMappingURL=getPropertiesAtLocation.js.map